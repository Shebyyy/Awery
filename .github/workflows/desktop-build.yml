name: Build Desktop

on:
  push:
    tags:
      - 'v*.*.*'
      - 'desktop-*'
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows executable'
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      build_linux:
        description: 'Build Linux package'
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  JBR_VERSION: '21'
  JBR_BUILD: 'b1000.42'

jobs:
# ===================== WINDOWS =====================
  build-windows:
    name: Build Windows Desktop
    runs-on: windows-latest
    if: github.event.inputs.build_windows != 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK (for Gradle)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # üîë DOWNLOAD JBR (REQUIRED FOR JEWEL)
      - name: Download JetBrains Runtime (Windows)
        shell: bash
        run: |
          JBR_VERSION="21.0.9"
          JBR_BUILD="b895.149"
          JBR_NAME="jbr_jcef-${JBR_VERSION}-windows-x64-${JBR_BUILD}"
          JBR_ARCHIVE="${JBR_NAME}.zip"
          JBR_URL="https://github.com/JetBrains/JetBrainsRuntime/releases/download/jbr-release-${JBR_VERSION}${JBR_BUILD}/${JBR_ARCHIVE}"
      
          echo "Downloading $JBR_URL"
          curl -fL "$JBR_URL" -o "$JBR_ARCHIVE"
      
          unzip -q "$JBR_ARCHIVE"
      
          echo "JBR_HOME=$PWD/$JBR_NAME" >> "$GITHUB_ENV"


      - name: Get version info
        shell: bash
        run: |
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "VERSION_NAME=$(grep awery.app.versionName gradle.properties | cut -d= -f2)" >> $GITHUB_ENV

      - name: Build Windows EXE/MSI
        run: ./gradlew :app:packageExe :app:packageMsi --stacktrace

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p desktop-windows
          cp app/build/compose/binaries/main/exe/*.exe \
             desktop-windows/Awery-${VERSION_NAME}-${COMMIT_HASH}-windows.exe
          cp app/build/compose/binaries/main/msi/*.msi \
             desktop-windows/Awery-${VERSION_NAME}-${COMMIT_HASH}-windows.msi
          sha256sum desktop-windows/* > desktop-windows/checksums.txt

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-${{ env.COMMIT_HASH }}
          path: desktop-windows/

# ===================== LINUX =====================
  build-linux:
    name: Build Linux Desktop
    runs-on: ubuntu-latest
    if: github.event.inputs.build_linux != 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK (for Gradle)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # üîë DOWNLOAD JBR (REQUIRED FOR JEWEL)
      - name: Download JetBrains Runtime (Linux)
        run: |
          JBR_FILE=jbr_jcef-${JBR_VERSION}-linux-x64-${JBR_BUILD}.tar.gz
          curl -L -o $JBR_FILE \
            https://cache-redirector.jetbrains.com/intellij-jbr/$JBR_FILE
          tar -xzf $JBR_FILE
          echo "JBR_HOME=$PWD/jbr_jcef-${JBR_VERSION}" >> $GITHUB_ENV

      - name: Get version info
        run: |
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "VERSION_NAME=$(grep awery.app.versionName gradle.properties | cut -d= -f2)" >> $GITHUB_ENV

      - name: Build Linux DEB
        run: ./gradlew :app:packageDeb --stacktrace

      - name: Collect artifacts
        run: |
          mkdir -p desktop-linux
          cp app/build/compose/binaries/main/deb/*.deb \
             desktop-linux/Awery-${VERSION_NAME}-${COMMIT_HASH}-linux.deb
          sha256sum desktop-linux/* > desktop-linux/checksums.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux-${{ env.COMMIT_HASH }}
          path: desktop-linux/

# ===================== RELEASE =====================
  create-release:
    name: Create Desktop Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/**/*
          name: Desktop Release ${{ github.ref_name }}
          body: |
            ## üñ•Ô∏è Awery Desktop Release

            ‚úÖ **JetBrains Runtime bundled**
            ‚úÖ Jewel `DecoratedWindow` safe
            ‚úÖ No external Java required

            **Windows**
            - Portable `.exe`
            - Installer `.msi`

            **Linux**
            - `.deb` package

            **Checksums**
            Included for verification.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
